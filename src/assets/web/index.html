<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>zigbot operations dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@500;700;800&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-canvas: #12161c;
      --bg-grid: #1b2129;
      --bg-surface: #1a2029;
      --bg-surface-strong: #242b36;
      --line: #374151;
      --line-strong: #515f74;
      --text-main: #edf1f7;
      --text-dim: #a3afc2;
      --accent: #eba842;
      --accent-strong: #d99830;
      --ok: #55b48a;
      --warn: #d6a34e;
      --err: #dc6d63;
      --info: #5d9ecd;
      --ok-soft-bg: #1e3128;
      --ok-soft-line: #3f7a60;
      --warn-soft-bg: #342a1d;
      --warn-soft-line: #8e6a34;
      --err-soft-bg: #342021;
      --err-soft-line: #8b4a4b;
      --line-soft: #2d3644;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--text-main);
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      min-height: 100vh;
      background-color: var(--bg-canvas);
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 1;
      background:
        repeating-linear-gradient(
          0deg,
          transparent 0 46px,
          var(--bg-grid) 46px 47px
        ),
        repeating-linear-gradient(
          90deg,
          transparent 0 46px,
          var(--bg-grid) 46px 47px
        );
      z-index: 0;
    }

    .dashboard {
      width: min(1240px, calc(100% - 32px));
      margin: 16px auto 28px;
      display: grid;
      gap: 14px;
      position: relative;
      z-index: 1;
    }

    .topbar {
      border: 2px solid var(--line-strong);
      background: var(--bg-surface);
      border-radius: 8px;
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      animation: riseIn 450ms ease-out both;
    }

    .brand {
      display: grid;
      gap: 6px;
    }

    .brand h1 {
      margin: 0;
      font-family: "Bricolage Grotesque", sans-serif;
      font-size: clamp(1.4rem, 2.5vw, 2rem);
      line-height: 0.95;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .brand p {
      margin: 0;
      color: var(--text-dim);
      font-size: 0.82rem;
      letter-spacing: 0.01em;
    }

    .badge-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      margin-left: auto;
    }

    .badge {
      border-radius: 999px;
      border: 2px solid var(--line);
      background: var(--bg-surface-strong);
      color: var(--text-main);
      font-size: 0.74rem;
      font-family: "IBM Plex Mono", monospace;
      letter-spacing: 0.02em;
      padding: 7px 12px;
      white-space: nowrap;
      transition: transform 150ms ease, border-color 150ms ease;
    }

    .badge.ok {
      color: var(--ok);
      border-color: var(--ok-soft-line);
      background: var(--ok-soft-bg);
    }

    .badge.warn {
      color: var(--warn);
      border-color: var(--warn-soft-line);
      background: var(--warn-soft-bg);
    }

    .badge.err {
      color: var(--err);
      border-color: var(--err-soft-line);
      background: var(--err-soft-bg);
    }

    .kpi-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .kpi-card {
      background: var(--bg-surface);
      border: 2px solid var(--line);
      border-radius: 8px;
      padding: 14px;
      display: grid;
      gap: 6px;
      animation: riseIn 450ms ease-out both;
    }

    .kpi-card:nth-child(1) { border-top: 5px solid var(--accent); animation-delay: 40ms; }
    .kpi-card:nth-child(2) { border-top: 5px solid var(--info); animation-delay: 80ms; }
    .kpi-card:nth-child(3) { border-top: 5px solid var(--ok); animation-delay: 120ms; }
    .kpi-card:nth-child(4) { border-top: 5px solid var(--err); animation-delay: 160ms; }

    .kpi-label {
      color: var(--text-dim);
      font-size: 0.73rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: "IBM Plex Mono", monospace;
    }

    .kpi-value {
      font-family: "Bricolage Grotesque", sans-serif;
      font-size: clamp(1.3rem, 2.4vw, 2rem);
      letter-spacing: 0.01em;
      line-height: 1;
    }

    .kpi-note {
      color: var(--text-dim);
      font-size: 0.74rem;
      opacity: 0.8;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px;
    }

    .panel {
      grid-column: span 4;
      border: 2px solid var(--line);
      border-radius: 8px;
      background: var(--bg-surface);
      padding: 14px;
      min-height: 220px;
      animation: riseIn 500ms ease-out both;
      transition: border-color 180ms ease, transform 180ms ease, background-color 180ms ease;
    }

    .panel:hover {
      border-color: var(--accent-strong);
      background-color: #202834;
      transform: translateY(-1px);
    }

    .panel:nth-child(1) { animation-delay: 200ms; }
    .panel:nth-child(2) { animation-delay: 240ms; }
    .panel:nth-child(3) { animation-delay: 280ms; }
    .panel:nth-child(4) { animation-delay: 320ms; }
    .panel:nth-child(5) { animation-delay: 360ms; }

    .panel.wide {
      grid-column: span 8;
    }

    .panel h2 {
      margin: 0 0 12px;
      font-family: "Bricolage Grotesque", sans-serif;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent-strong);
    }

    .kv {
      margin: 0;
      display: grid;
      gap: 7px;
      font-size: 0.84rem;
    }

    .kv div {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--line-soft);
    }

    .kv dt {
      color: var(--text-dim);
      font-size: 0.78rem;
    }

    .kv dd {
      margin: 0;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: "IBM Plex Mono", monospace;
      max-width: 60%;
      overflow-wrap: anywhere;
    }

    .kv dd.value-inline-nowrap {
      max-width: 75%;
      white-space: nowrap;
      overflow-wrap: normal;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .control-strip {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
      margin-left: 8px;
    }

    .control-button {
      border-radius: 999px;
      border: 2px solid var(--line-strong);
      background: var(--bg-surface-strong);
      color: var(--text-main);
      font-size: 0.72rem;
      font-family: "IBM Plex Mono", monospace;
      padding: 8px 12px;
      cursor: pointer;
      transition: border-color 150ms ease, transform 150ms ease, background-color 150ms ease;
      white-space: nowrap;
    }

    .control-button:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .control-button:disabled {
      opacity: 0.5;
      cursor: wait;
      transform: none;
    }

    .control-feedback {
      grid-column: span 2;
      margin: 0;
      font-size: 0.7rem;
      font-family: "IBM Plex Mono", monospace;
      color: var(--text-dim);
      text-align: right;
      display: none;
    }

    .control-feedback.visible {
      display: block;
    }

    .control-feedback.ok { color: var(--ok); }
    .control-feedback.warn { color: var(--warn); }
    .control-feedback.err { color: var(--err); }

    .meter-wrap {
      margin-top: 12px;
      display: grid;
      gap: 6px;
    }

    .meter {
      height: 12px;
      border-radius: 999px;
      background: #1d2430;
      border: 2px solid #3d4b60;
      overflow: hidden;
    }

    .meter-fill {
      width: 0;
      height: 100%;
      border-radius: inherit;
      background: var(--ok);
      transition: width 320ms ease;
    }

    .meter-fill.warn {
      background: var(--accent);
    }

    .meter-fill.err {
      background: var(--err);
    }

    .meter-label {
      color: var(--text-dim);
      font-size: 0.74rem;
      font-family: "IBM Plex Mono", monospace;
    }

    .timeline {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 10px;
    }

    .timeline-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      background: var(--bg-surface-strong);
      border: 2px solid var(--line);
      border-radius: 8px;
      padding: 10px;
    }

    .timeline-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      box-shadow: none;
      color: var(--accent);
    }

    .timeline-dot.ok { color: var(--ok); }
    .timeline-dot.warn { color: var(--warn); }
    .timeline-dot.err { color: var(--err); }

    .timeline-copy {
      display: grid;
      gap: 2px;
      min-width: 0;
    }

    .timeline-copy strong {
      font-size: 0.79rem;
      line-height: 1.3;
      overflow-wrap: anywhere;
    }

    .timeline-copy span {
      color: var(--text-dim);
      font-size: 0.7rem;
      font-family: "IBM Plex Mono", monospace;
    }

    .catalog-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .catalog-group h3 {
      margin: 0 0 8px;
      color: var(--accent-strong);
      font-family: "Bricolage Grotesque", sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      color: var(--text-main);
      font-size: 0.82rem;
      line-height: 1.2;
    }

    .list li {
      overflow-wrap: anywhere;
    }

    .error-console {
      margin: 10px 0 0;
      border-radius: 8px;
      border: 2px solid var(--line);
      background: var(--bg-surface-strong);
      padding: 10px;
      min-height: 84px;
      color: var(--text-main);
      font-size: 0.78rem;
      line-height: 1.35;
      font-family: "IBM Plex Mono", monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-console.ok {
      border-color: var(--ok-soft-line);
      color: var(--ok);
    }

    .error-console.err {
      border-color: var(--err-soft-line);
      color: var(--err);
      animation: pulseAlert 2.2s ease-in-out infinite;
    }

    @keyframes pulseAlert {
      0%, 100% { background-color: var(--bg-surface-strong); }
      50% { background-color: var(--err-soft-bg); }
    }

    @keyframes riseIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 1080px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .panel {
        grid-column: span 6;
      }

      .panel.wide {
        grid-column: span 12;
      }
    }

    @media (max-width: 760px) {
      .dashboard {
        width: min(1240px, calc(100% - 18px));
        margin-top: 12px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .badge-strip {
        justify-content: flex-start;
        flex-wrap: wrap;
        margin-left: 0;
      }

      .control-strip {
        width: 100%;
        justify-content: flex-start;
      }

      .control-feedback {
        text-align: left;
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .panel,
      .panel.wide {
        grid-column: span 12;
      }

      .catalog-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <section class="topbar">
      <div class="brand">
        <h1>zigbot operations dashboard</h1>
        <p id="updatedAt">Connecting to status API...</p>
      </div>
      <div class="badge-strip">
        <div class="badge" id="badgeAgent">agent: unknown</div>
        <div class="badge" id="badgeHeartbeat">heartbeat: unknown</div>
        <div class="badge" id="badgePoll">poll: unknown</div>
      </div>
      <div class="control-strip">
        <button class="control-button" id="btnHeartbeat" type="button">Trigger heartbeat</button>
        <button class="control-button" id="btnSessionTimeout" type="button">Force session timeout</button>
        <p class="control-feedback" id="controlFeedback" aria-live="polite"></p>
      </div>
    </section>

    <section class="kpi-grid">
      <article class="kpi-card">
        <div class="kpi-label">Uptime</div>
        <div class="kpi-value" id="kpiUptime">--</div>
        <div class="kpi-note">continuous service runtime</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Telegram Messages</div>
        <div class="kpi-value" id="kpiMessages">--</div>
        <div class="kpi-note">total handled via polling loop</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Heartbeat Runs</div>
        <div class="kpi-value" id="kpiHeartbeats">--</div>
        <div class="kpi-note">scheduled execution count</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Poll Errors</div>
        <div class="kpi-value" id="kpiPollErrors">--</div>
        <div class="kpi-note">telegram polling failures observed</div>
      </article>
    </section>

    <section class="layout-grid">
      <article class="panel">
        <h2>Core Runtime</h2>
        <dl class="kv" id="coreStatus"></dl>
      </article>

      <article class="panel">
        <h2>Heartbeat Reliability</h2>
        <dl class="kv" id="heartbeatStatus"></dl>
        <div class="meter-wrap">
          <div class="meter">
            <div class="meter-fill" id="heartbeatMeterFill"></div>
          </div>
          <div class="meter-label" id="heartbeatMeterText">waiting for telemetry...</div>
        </div>
      </article>

      <article class="panel">
        <h2>Diagnostics</h2>
        <dl class="kv" id="diagnosticsStatus"></dl>
        <pre class="error-console ok" id="errorConsole">No active errors recorded.</pre>
      </article>

      <article class="panel wide">
        <h2>Recent Activity Timeline</h2>
        <ul class="timeline" id="timelineList"></ul>
      </article>

      <article class="panel">
        <h2>Automation Inventory</h2>
        <div class="catalog-grid">
          <section class="catalog-group">
            <h3>Skills</h3>
            <ul class="list" id="skillsList"></ul>
          </section>
          <section class="catalog-group">
            <h3>Extensions</h3>
            <ul class="list" id="extensionsList"></ul>
          </section>
        </div>
      </article>

    </section>
  </main>

  <script>
    const coreStatusEl = document.getElementById("coreStatus");
    const heartbeatStatusEl = document.getElementById("heartbeatStatus");
    const diagnosticsStatusEl = document.getElementById("diagnosticsStatus");
    const skillsEl = document.getElementById("skillsList");
    const extensionsEl = document.getElementById("extensionsList");
    const updatedAtEl = document.getElementById("updatedAt");
    const badgeAgentEl = document.getElementById("badgeAgent");
    const badgeHeartbeatEl = document.getElementById("badgeHeartbeat");
    const badgePollEl = document.getElementById("badgePoll");
    const timelineListEl = document.getElementById("timelineList");
    const errorConsoleEl = document.getElementById("errorConsole");
    const heartbeatMeterFillEl = document.getElementById("heartbeatMeterFill");
    const heartbeatMeterTextEl = document.getElementById("heartbeatMeterText");
    const kpiUptimeEl = document.getElementById("kpiUptime");
    const kpiMessagesEl = document.getElementById("kpiMessages");
    const kpiHeartbeatsEl = document.getElementById("kpiHeartbeats");
    const kpiPollErrorsEl = document.getElementById("kpiPollErrors");
    const btnHeartbeatEl = document.getElementById("btnHeartbeat");
    const btnSessionTimeoutEl = document.getElementById("btnSessionTimeout");
    const controlFeedbackEl = document.getElementById("controlFeedback");
    let controlFeedbackTimer = null;

    const numberFmt = new Intl.NumberFormat();

    function fmtTime(ms) {
      if (!ms || ms <= 0) return "never";
      return new Date(ms).toLocaleTimeString();
    }

    function fmtAgo(ms, nowMs) {
      if (!ms || ms <= 0) return "never";
      const sec = Math.max(0, Math.floor((nowMs - ms) / 1000));
      if (sec < 60) return `${sec}s ago`;
      const min = Math.floor(sec / 60);
      if (min < 60) return `${min}m ago`;
      const hr = Math.floor(min / 60);
      if (hr < 48) return `${hr}h ago`;
      const day = Math.floor(hr / 24);
      return `${day}d ago`;
    }

    function fmtRelative(ms, nowMs) {
      if (!ms || ms <= 0) return "never";
      const deltaSec = Math.floor((ms - nowMs) / 1000);
      if (deltaSec <= 0) return fmtAgo(ms, nowMs);

      if (deltaSec < 60) return `in ${deltaSec}s`;
      const min = Math.floor(deltaSec / 60);
      if (min < 60) return `in ${min}m`;
      const hr = Math.floor(min / 60);
      if (hr < 48) return `in ${hr}h`;
      const day = Math.floor(hr / 24);
      return `in ${day}d`;
    }

    function fmtDuration(totalSeconds) {
      const seconds = Math.max(0, Number(totalSeconds) || 0);
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      if (minutes > 0) return `${minutes}m`;
      return `${seconds}s`;
    }

    function fmtCount(value) {
      return numberFmt.format(Number(value) || 0);
    }

    function fmtMs(value) {
      const ms = Number(value);
      if (!Number.isFinite(ms) || ms <= 0) return "n/a";
      return `${ms}ms`;
    }

    function fmtSessionTtlRemaining(status) {
      if ((Number(status.pi_session_ttl_seconds) || 0) <= 0) return "disabled";
      if (!status.pi_session_active) return "no active session";
      const remainingMs = Number(status.pi_session_ttl_remaining_ms);
      if (!Number.isFinite(remainingMs) || remainingMs < 0) return "n/a";
      const expiresAtMs = Number(status.pi_session_expires_at_ms);
      if (!Number.isFinite(expiresAtMs) || expiresAtMs <= 0) {
        return fmtDuration(Math.ceil(remainingMs / 1000));
      }
      return `${fmtDuration(Math.ceil(remainingMs / 1000))} (${fmtRelative(expiresAtMs, status.now_ms)})`;
    }

    async function fetchJson(url, opts) {
      const response = await fetch(url, opts);
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data && data.error ? data.error : `request failed (${response.status})`;
        throw new Error(message);
      }
      return data;
    }

    function setBadge(element, text, kind) {
      element.className = `badge ${kind || ""}`.trim();
      element.textContent = text;
    }

    function renderKv(element, rows) {
      element.textContent = "";
      for (const [label, value, valueClass] of rows) {
        const row = document.createElement("div");
        const dt = document.createElement("dt");
        const dd = document.createElement("dd");
        dt.textContent = label;
        dd.textContent = value;
        if (valueClass) dd.classList.add(valueClass);
        row.append(dt, dd);
        element.appendChild(row);
      }
    }

    function renderStringList(element, values) {
      element.textContent = "";
      const items = values && values.length > 0 ? values : ["(none found)"];
      for (const value of items) {
        const li = document.createElement("li");
        li.textContent = value;
        element.appendChild(li);
      }
    }

    function classifyHeartbeatHealth(status) {
      if (status.heartbeat_run_count <= 0) return 100;
      const failureRate = status.heartbeat_error_count / status.heartbeat_run_count;
      const baseScore = status.last_heartbeat_ok ? 100 : 72;
      return Math.max(0, Math.round(baseScore - (failureRate * 72)));
    }

    function timelineFromStatus(status, nowMs) {
      const events = [];
      if (status.last_poll_ms > 0) {
        events.push({
          ms: status.last_poll_ms,
          title: status.last_poll_ok ? "Telegram poll completed" : "Telegram poll failed",
          meta: `${fmtTime(status.last_poll_ms)} (${fmtAgo(status.last_poll_ms, nowMs)})`,
          kind: status.last_poll_ok ? "ok" : "err",
        });
      }
      if (status.last_heartbeat_started_ms > 0) {
        events.push({
          ms: status.last_heartbeat_started_ms,
          title: "Heartbeat started",
          meta: `${fmtTime(status.last_heartbeat_started_ms)} (${fmtAgo(status.last_heartbeat_started_ms, nowMs)})`,
          kind: "warn",
        });
      }
      if (status.last_heartbeat_finished_ms > 0) {
        events.push({
          ms: status.last_heartbeat_finished_ms,
          title: status.last_heartbeat_ok ? "Heartbeat finished cleanly" : "Heartbeat finished with error",
          meta: `${fmtTime(status.last_heartbeat_finished_ms)} (${fmtAgo(status.last_heartbeat_finished_ms, nowMs)})`,
          kind: status.last_heartbeat_ok ? "ok" : "err",
        });
      }
      if (status.agent_busy && status.active_task_started_ms > 0) {
        events.push({
          ms: status.active_task_started_ms,
          title: `Agent working on ${status.active_task}`,
          meta: `${fmtTime(status.active_task_started_ms)} (${fmtAgo(status.active_task_started_ms, nowMs)})`,
          kind: "warn",
        });
      }
      events.sort((a, b) => b.ms - a.ms);
      return events.slice(0, 8);
    }

    function renderTimeline(events) {
      timelineListEl.textContent = "";
      if (!events.length) {
        const empty = document.createElement("li");
        empty.className = "timeline-item";
        const dot = document.createElement("span");
        dot.className = "timeline-dot warn";
        const copy = document.createElement("div");
        copy.className = "timeline-copy";
        const title = document.createElement("strong");
        title.textContent = "No activity recorded yet";
        const meta = document.createElement("span");
        meta.textContent = "Waiting for first poll, heartbeat, or workload.";
        copy.append(title, meta);
        empty.append(dot, copy);
        timelineListEl.appendChild(empty);
        return;
      }

      for (const event of events) {
        const li = document.createElement("li");
        li.className = "timeline-item";

        const dot = document.createElement("span");
        dot.className = `timeline-dot ${event.kind}`;

        const copy = document.createElement("div");
        copy.className = "timeline-copy";

        const title = document.createElement("strong");
        title.textContent = event.title;
        const meta = document.createElement("span");
        meta.textContent = event.meta;

        copy.append(title, meta);
        li.append(dot, copy);
        timelineListEl.appendChild(li);
      }
    }

    function renderErrors(status) {
      const errors = [];
      if (status.last_poll_error) errors.push(`[poll] ${status.last_poll_error}`);
      if (status.last_heartbeat_error) errors.push(`[heartbeat] ${status.last_heartbeat_error}`);
      if (status.last_telegram_error) errors.push(`[telegram] ${status.last_telegram_error}`);

      if (!errors.length) {
        errorConsoleEl.className = "error-console ok";
        errorConsoleEl.textContent = "No active errors recorded.";
        return;
      }

      errorConsoleEl.className = "error-console err";
      errorConsoleEl.textContent = errors.join("\n");
    }

    async function refreshStatus() {
      try {
        const status = await fetchJson("/api/status");
        const nowMs = status.now_ms;
        const activeFor = status.agent_busy
          ? `${Math.max(0, Math.floor((nowMs - status.active_task_started_ms) / 1000))}s`
          : "0s";
        const nextHeartbeat = status.next_heartbeat_ms
          ? `${fmtTime(status.next_heartbeat_ms)} (${fmtRelative(status.next_heartbeat_ms, nowMs)})`
          : "disabled";
        const healthScore = classifyHeartbeatHealth(status);
        const telegramBusyRejects = Number(status.telegram_busy_reject_count) || 0;
        const providerName = status.provider || "default";
        const modelName = status.model || "default";
        const heartbeatMode = status.heartbeat_execution_mode || "threaded";

        updatedAtEl.textContent = `Updated ${new Date(nowMs).toLocaleString()} Â· Uptime ${fmtDuration(status.uptime_seconds)}`;

        kpiUptimeEl.textContent = fmtDuration(status.uptime_seconds);
        kpiMessagesEl.textContent = fmtCount(status.telegram_message_count);
        kpiHeartbeatsEl.textContent = fmtCount(status.heartbeat_run_count);
        kpiPollErrorsEl.textContent = fmtCount(status.poll_error_count);

        renderKv(coreStatusEl, [
          ["Agent state", status.agent_busy ? "busy" : "idle"],
          ["Active task", status.active_task],
          ["Active runtime", activeFor],
          ["Heartbeat mode", heartbeatMode],
          ["Started", new Date(status.started_ms).toLocaleTimeString()],
          ["Heartbeat interval", status.heartbeat_enabled ? `${status.heartbeat_interval_seconds}s` : "disabled"],
          ["Pi session TTL", status.pi_session_ttl_seconds > 0 ? `${status.pi_session_ttl_seconds}s (max-age)` : "disabled"],
          ["Pi session remaining", fmtSessionTtlRemaining(status)],
          ["Poll timeout", `${status.polling_timeout_seconds}s`],
          ["Owner chat lock", status.owner_chat_restricted ? "enabled" : "off"],
          ["Provider / model", `${providerName} / ${modelName}`, "value-inline-nowrap"],
          ["Telegram messages", fmtCount(status.telegram_message_count)],
          ["Telegram busy rejects", fmtCount(telegramBusyRejects)],
        ]);

        renderKv(heartbeatStatusEl, [
          ["Execution mode", heartbeatMode],
          ["Next run", nextHeartbeat],
          ["Total runs", fmtCount(status.heartbeat_run_count)],
          ["Error count", fmtCount(status.heartbeat_error_count)],
          ["Last started", `${fmtTime(status.last_heartbeat_started_ms)} (${fmtAgo(status.last_heartbeat_started_ms, nowMs)})`],
          ["Last finished", `${fmtTime(status.last_heartbeat_finished_ms)} (${fmtAgo(status.last_heartbeat_finished_ms, nowMs)})`],
          ["Last duration", fmtMs(status.last_heartbeat_duration_ms)],
          ["Last result", status.last_heartbeat_ok ? "ok" : "error"],
        ]);

        renderKv(diagnosticsStatusEl, [
          ["Last poll", `${fmtTime(status.last_poll_ms)} (${fmtAgo(status.last_poll_ms, nowMs)})`],
          ["Last poll result", status.last_poll_ok ? "ok" : "error"],
          ["Poll error total", fmtCount(status.poll_error_count)],
          ["Telegram busy rejects", fmtCount(status.telegram_busy_reject_count)],
          ["Telegram generation errors", fmtCount(status.telegram_generation_error_count)],
          ["Telegram send errors", fmtCount(status.telegram_send_error_count)],
        ]);

        heartbeatMeterFillEl.style.width = `${healthScore}%`;
        heartbeatMeterFillEl.className = `meter-fill ${
          healthScore >= 80 ? "" : healthScore >= 50 ? "warn" : "err"
        }`.trim();
        heartbeatMeterTextEl.textContent = `Heartbeat health score: ${healthScore}%`;

        renderTimeline(timelineFromStatus(status, nowMs));
        renderErrors(status);

        setBadge(
          badgeAgentEl,
          status.agent_busy
            ? `agent: busy (${status.active_task})`
            : "agent: idle",
          status.agent_busy ? "warn" : "ok"
        );
        setBadge(
          badgeHeartbeatEl,
          status.heartbeat_enabled
            ? (status.last_heartbeat_ok ? "heartbeat: healthy" : "heartbeat: failing")
            : "heartbeat: disabled",
          status.heartbeat_enabled ? (status.last_heartbeat_ok ? "ok" : "err") : "warn"
        );
        setBadge(
          badgePollEl,
          status.last_poll_ok ? "poll: healthy" : "poll: failing",
          status.last_poll_ok ? "ok" : "err"
        );
      } catch (error) {
        updatedAtEl.textContent = `Status unavailable: ${error.message}`;
        setBadge(badgeAgentEl, "agent: unavailable", "err");
        setBadge(badgeHeartbeatEl, "heartbeat: unavailable", "err");
        setBadge(badgePollEl, "poll: unavailable", "err");
      }
    }

    async function refreshStaticLists() {
      try {
        const skills = await fetchJson("/api/skills");
        renderStringList(skillsEl, skills.skills);
      } catch (error) {
        renderStringList(skillsEl, [`error: ${error.message}`]);
      }

      try {
        const extensions = await fetchJson("/api/extensions");
        renderStringList(extensionsEl, extensions.extensions);
      } catch (error) {
        renderStringList(extensionsEl, [`error: ${error.message}`]);
      }
    }

    function setControlFeedback(message, kind) {
      if (controlFeedbackTimer) {
        clearTimeout(controlFeedbackTimer);
        controlFeedbackTimer = null;
      }

      if (!message) {
        controlFeedbackEl.className = "control-feedback";
        controlFeedbackEl.textContent = "";
        return;
      }

      const tone = kind || "info";
      controlFeedbackEl.className = `control-feedback visible ${tone}`.trim();
      controlFeedbackEl.textContent = message;

      controlFeedbackTimer = setTimeout(() => {
        controlFeedbackEl.className = "control-feedback";
        controlFeedbackEl.textContent = "";
        controlFeedbackTimer = null;
      }, 4000);
    }

    function setControlsDisabled(disabled) {
      btnHeartbeatEl.disabled = disabled;
      btnSessionTimeoutEl.disabled = disabled;
    }

    async function runControlAction(url, pendingMessage, onSuccess) {
      setControlsDisabled(true);
      setControlFeedback(pendingMessage, "warn");
      try {
        const result = await fetchJson(url, { method: "POST" });
        setControlFeedback(onSuccess(result), "ok");
      } catch (error) {
        const tone = /busy/i.test(error.message) ? "warn" : "err";
        setControlFeedback(error.message, tone);
      } finally {
        setControlsDisabled(false);
        refreshStatus();
      }
    }

    btnHeartbeatEl.addEventListener("click", () => {
      runControlAction(
        "/api/heartbeat",
        "Triggering heartbeat...",
        () => "Heartbeat accepted, running now."
      );
    });

    btnSessionTimeoutEl.addEventListener("click", () => {
      runControlAction(
        "/api/pi-session/expire",
        "Forcing session timeout...",
        (result) => result.status === "expired"
          ? "Session expired, next request will create a new one."
          : "No active shared session to expire."
      );
    });

    refreshStatus();
    refreshStaticLists();
    setInterval(refreshStatus, 3000);
    setInterval(refreshStaticLists, 30000);
  </script>
</body>
</html>
